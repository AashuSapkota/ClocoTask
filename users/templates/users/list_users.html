{% extends 'dashboard/base.html' %}
{% block pagehead %}
Users List
{% endblock pagehead %}
{% block body %}
<table class="table" id="user-table">

</table>

{% endblock %}

{% block js %}
<script>
    const loginUrl = "{% url 'users:login' %}"
    const listUrl = "{% url 'users:list_users' %}"
    $(document).ready(function () {
        console.log('here')
        const accessToken = localStorage.getItem('access_token');
        var table = document.getElementById('user-table');
        $.ajax({
            url: listUrl,
            type: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`
            },
            success: function (response) {
                console.log(response)
                table.innerHTML = '';
                var thead = document.createElement('thead');
                var tr = document.createElement('tr');
                tr.innerHTML = '<th scope="col">Full Name</th><th scope="col">Gender</th><th scope="col">Email</th><th scope="col">Phone</th><th scope="col">DOB</th><th scope="col">Actions</th>';
                thead.appendChild(tr);
                table.appendChild(thead);

                // Create table body
                var tbody = document.createElement('tbody');
                response.results.forEach(function (user) {
                    var tr = document.createElement('tr');
                    var editUrl = '{% url "users:update_user" user_id=0 %}'.replace('0', user.id);
                    console.log(editUrl)
                    var deleteUrl = '{% url "users:delete_user" user_id=0 %}'.replace('0', user.id);
                    console.log(deleteUrl)
                    tr.innerHTML = '<td>' + user.first_name + " " + user.last_name +
                        '</td><td>' + user.gender +
                        '</td><td>' + user.email +
                        '</td><td>' + user.phone +
                        '</td><td>' + formatDOB(user.dob) +
                        '</td>' + '<td><a class="edit-button" href="' + editUrl + '">Edit</a>' +
                        " " + '<a class="delete-button" href="#" data-deleteurl="' + deleteUrl + '">Delete</a><td>' +
                        '<td hidden class="user_id">' + user.id + '</td>';
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                // Function to format the date of birth
                function formatDOB(dob) {
                    var date = new Date(dob);
                    var year = date.getFullYear();
                    var month = ('0' + (date.getMonth() + 1)).slice(-2); // Add leading zero if needed
                    var day = ('0' + date.getDate()).slice(-2); // Add leading zero if needed
                    return year + '-' + month + '-' + day;
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                if (xhr.status == 401) {
                    window.location.href = loginUrl;
                };
            }
        })
    });

    var table = document.getElementById('user-table');
    table.addEventListener('click', function (event) {
        if (event.target.classList.contains('delete-button')) {
            event.preventDefault();
            var confirmDelete = confirm('Are you sure you want to delete this user?');
            if (confirmDelete) {
                var deleteUrl = event.target.dataset.deleteurl;
                var accessToken = localStorage.getItem('access_token');
                console.log("deleteurl: ", deleteUrl)
                $.ajax({
                    url: deleteUrl,
                    method: 'DELETE',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    success: function (response) {
                        console.log("Response", response.Status)
                        if (response.Status === 'Success') {
                            window.location.href = listUrl;
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.log(xhr)
                    }
                })
            }
        }
    });
</script>

{% endblock js %}